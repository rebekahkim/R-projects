---
title: "STAT UN2103 HW5"
author: "Rebekah Kim"
date: "November 29, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

### I. Introduction

```{r}
df <- read.csv("salary.txt", header = T)

set.seed(0)
index <- sample(1:nrow(df),4965,replace = F)
train.data <- df[-index,]
data <- train.data 
test.data <- df[index,]

head(df)
str(df)

#got 34% for this 
#summary(lm(log(wage)~edu+I(edu^2)+exp+I(exp^2)+city+reg+race+deg+com,data=train.data))
#35%
#summary(lm(log(wage)~edu+I(edu^2)+exp+I(exp^2)+city+city*exp*edu+reg+race+deg+com,data=train.data))
#35.26%
#summary(lm(log(wage)~edu+I(edu^2)+exp+I(exp^2)+city+city*edu*exp*deg+reg*city+reg*exp*edu*deg+race*exp*edu*deg*city+reg+race+deg+com,data=train.data))

# exploratory data analysis

ggplot(df)+
  geom_boxplot(aes(x = reg, y = log(wage), fill = race))

ggplot(data, aes(x = exp, y = log(wage), group = race, color = race)) +
  geom_smooth()

ggplot(data, aes(x = race, y = log(wage)))+
  geom_point()+
  geom_smooth()

#subset
library(leaps)
library(bestglm)
min.model <- lm(wage~1, data=data)
full.model <- formula(lm(wage~edu+exp+( edu* exp)+
( city)+
( edu* city)+
( exp* city)+
( edu* exp* city)+
( reg)+
( edu* reg)+
( exp* reg)+
( edu* exp* reg)+
( city* reg)+
( edu* city* reg)+
( exp* city* reg)+
( edu* exp* city* reg)+
( race)+
( edu* race)+
( exp* race)+
( edu* exp* race)+
( city* race)+
( edu* city* race)+
( exp* city* race)+
( edu* exp* city* race)+
( reg* race)+
( edu* reg* race)+
( exp* reg* race)+
( edu* exp* reg* race)+
( city* reg* race)+
( edu* city* reg* race)+
( exp* city* reg* race)+
( edu* exp* city* reg* race)+
( deg)+
( edu* deg)+
( exp* deg)+
( edu* exp* deg)+
( city* deg)+
( edu* city* deg)+
( exp* city* deg)+
( edu* exp* city* deg)+
( reg* deg)+
( edu* reg* deg)+
( exp* reg* deg)+
( edu* exp* reg* deg)+
( city* reg* deg)+
( edu* city* reg* deg)+
( exp* city* reg* deg)+
( edu* exp* city* reg* deg)+
( race* deg)+
( edu* race* deg)+
( exp* race* deg)+
( edu* exp* race* deg)+
( city* race* deg)+
( edu* city* race* deg)+
( exp* city* race* deg)+
( edu* exp* city* race* deg)+
( reg* race* deg)+
( edu* reg* race* deg)+
( exp* reg* race* deg)+
( edu* exp* reg* race* deg)+
( city* reg* race* deg)+
( edu* city* reg* race* deg)+
( exp* city* reg* race* deg)+
( edu* exp* city* reg* race* deg)+
( com)+
( edu* com)+
( exp* com)+
( edu* exp* com)+
( city* com)+
( edu* city* com)+
( exp* city* com)+
( edu* exp* city* com)+
( reg* com)+
( edu* reg* com)+
( exp* reg* com)+
( edu* exp* reg* com)+
( city* reg* com)+
( edu* city* reg* com)+
( exp* city* reg* com)+
( edu* exp* city* reg* com)+
( race* com)+
( edu* race* com)+
( exp* race* com)+
( edu* exp* race* com)+
( city* race* com)+
( edu* city* race* com)+
( exp* city* race* com)+
( edu* exp* city* race* com)+
( reg* race* com)+
( edu* reg* race* com)+
( exp* reg* race* com)+
( edu* exp* reg* race* com)+
( city* reg* race* com)+
( edu* city* reg* race* com)+
( exp* city* reg* race* com)+
( edu* exp* city* reg* race* com)+
( deg* com)+
( edu* deg* com)+
( exp* deg* com)+
( edu* exp* deg* com)+
( city* deg* com)+
( edu* city* deg* com)+
( exp* city* deg* com)+
( edu* exp* city* deg* com)+
( reg* deg* com)+
( edu* reg* deg* com)+
( exp* reg* deg* com)+
( edu* exp* reg* deg* com)+
( city* reg* deg* com)+
( edu* city* reg* deg* com)+
( exp* city* reg* deg* com)+
( edu* exp* city* reg* deg* com)+
( race* deg* com)+
( edu* race* deg* com)+
( exp* race* deg* com)+
( edu* exp* race* deg* com)+
( city* race* deg* com)+
( edu* city* race* deg* com)+
( exp* city* race* deg* com)+
( edu* exp* city* race* deg* com)+
( reg* race* deg* com)+
( edu* reg* race* deg* com)+
( exp* reg* race* deg* com)+
( edu* exp* reg* race* deg* com)+
( city* reg* race* deg* com)+
( edu* city* reg* race* deg* com)+
( exp* city* reg* race* deg* com)+
( edu* exp* city* reg* race* deg* com)+
( emp)+
( edu* emp)+
( exp* emp)+
( edu* exp* emp)+
( city* emp)+
( edu* city* emp)+
( exp* city* emp)+
( edu* exp* city* emp)+
( reg* emp)+
( edu* reg* emp)+
( exp* reg* emp)+
( edu* exp* reg* emp)+
( city* reg* emp)+
( edu* city* reg* emp)+
( exp* city* reg* emp)+
( edu* exp* city* reg* emp)+
( race* emp)+
( edu* race* emp)+
( exp* race* emp)+
( edu* exp* race* emp)+
( city* race* emp)+
( edu* city* race* emp)+
( exp* city* race* emp)+
( edu* exp* city* race* emp)+
( reg* race* emp)+
( edu* reg* race* emp)+
( exp* reg* race* emp)+
( edu* exp* reg* race* emp)+
( city* reg* race* emp)+
( edu* city* reg* race* emp)+
( exp* city* reg* race* emp)+
( edu* exp* city* reg* race* emp)+
( deg* emp)+
( edu* deg* emp)+
( exp* deg* emp)+
( edu* exp* deg* emp)+
( city* deg* emp)+
( edu* city* deg* emp)+
( exp* city* deg* emp)+
( edu* exp* city* deg* emp)+
( reg* deg* emp)+
( edu* reg* deg* emp)+
( exp* reg* deg* emp)+
( edu* exp* reg* deg* emp)+
( city* reg* deg* emp)+
( edu* city* reg* deg* emp)+
( exp* city* reg* deg* emp)+
( edu* exp* city* reg* deg* emp)+
( race* deg* emp)+
( edu* race* deg* emp)+
( exp* race* deg* emp)+
( edu* exp* race* deg* emp)+
( city* race* deg* emp)+
( edu* city* race* deg* emp)+
( exp* city* race* deg* emp)+
( edu* exp* city* race* deg* emp)+
( reg* race* deg* emp)+
( edu* reg* race* deg* emp)+
( exp* reg* race* deg* emp)+
( edu* exp* reg* race* deg* emp)+
( city* reg* race* deg* emp)+
( edu* city* reg* race* deg* emp)+
( exp* city* reg* race* deg* emp)+
( edu* exp* city* reg* race* deg* emp)+
( com* emp)+
( edu* com* emp)+
( exp* com* emp)+
( edu* exp* com* emp)+
( city* com* emp)+
( edu* city* com* emp)+
( exp* city* com* emp)+
( edu* exp* city* com* emp)+
( reg* com* emp)+
( edu* reg* com* emp)+
( exp* reg* com* emp)+
( edu* exp* reg* com* emp)+
( city* reg* com* emp)+
( edu* city* reg* com* emp)+
( exp* city* reg* com* emp)+
( edu* exp* city* reg* com* emp)+
( race* com* emp)+
( edu* race* com* emp)+
( exp* race* com* emp)+
( edu* exp* race* com* emp)+
( city* race* com* emp)+
( edu* city* race* com* emp)+
( exp* city* race* com* emp)+
( edu* exp* city* race* com* emp)+
( reg* race* com* emp)+
( edu* reg* race* com* emp)+
( exp* reg* race* com* emp)+
( edu* exp* reg* race* com* emp)+
( city* reg* race* com* emp)+
( edu* city* reg* race* com* emp)+
( exp* city* reg* race* com* emp)+
( edu* exp* city* reg* race* com* emp)+
( deg* com* emp)+
( edu* deg* com* emp)+
( exp* deg* com* emp)+
( edu* exp* deg* com* emp)+
( city* deg* com* emp)+
( edu* city* deg* com* emp)+
( exp* city* deg* com* emp)+
( edu* exp* city* deg* com* emp)+
( reg* deg* com* emp)+
( edu* reg* deg* com* emp)+
( exp* reg* deg* com* emp)+
( edu* exp* reg* deg* com* emp)+
( city* reg* deg* com* emp)+
( edu* city* reg* deg* com* emp)+
( exp* city* reg* deg* com* emp)+
( edu* exp* city* reg* deg* com* emp)+
( race* deg* com* emp)+
( edu* race* deg* com* emp)+
( exp* race* deg* com* emp)+
( edu* exp* race* deg* com* emp)+
( city* race* deg* com* emp)+
( edu* city* race* deg* com* emp)+
( exp* city* race* deg* com* emp)+
( edu* exp* city* race* deg* com* emp)+
( reg* race* deg* com* emp)+
( edu* reg* race* deg* com* emp)+
( exp* reg* race* deg* com* emp)+
( edu* exp* reg* race* deg* com* emp)+
( city* reg* race* deg* com* emp)+
( edu* city* reg* race* deg* com* emp)+
( exp* city* reg* race* deg* com* emp)+
( edu* exp* city* reg* race* deg* com* emp)+I(exp^2)+I(edu^2), data = data))
step(min.model,scope = full.model, direction = c("forward"))




white_midwest <- df %>% filter(race =="white", reg == "midwest")

df$reg2 <- as.character(df$reg)
regions <- unique(df$reg2)
df$deg01[df$deg == "yes"] <- 1
df$deg01[df$deg == "no"] <- 4

#par(mfrow =c(2,2))

black <- df$race=="black"
white <- df$race=="white"
other <- df$race=="other"


df$color[black] = "red"
df$color[white] = "blue"
df$color[other] = "green"


for(r in regions){
  df.sub <- df[df$reg2 == r,]
  plot(df.sub$exp,
       log(df.sub$wage),
       #col= df$color,
       pch=df.sub$deg01,
       main = r)
  #lines(supsmu(df$edu))

lines(supsmu(df$exp[black],log(df$wage)[black]),col=df$color[black] )
lines(supsmu(df$exp[white],log(df$wage)[white]),col=df$color[white] )
lines(supsmu(df$exp[other],log(df$wage)[other]),col=df$color[other] )
legend("topleft",legend=c("Black","White","Other"), col=c(2,4,3),lty=c(1,1,1)) 
legend("topright", legend=c("College degree", "No college degree"), pch=c(1,4))
}


#http://stackoverflow.com/questions/17551193/r-color-scatter-plot-points-based-on-values


# Pick trainging and test data

# Use sample 
# Set seed to 0 
set.seed(0)
index <- sample(1:nrow(df),4965,replace = F)
train.data <- df[-index,]
data <- train.data 
test.data <- df[index,]


# Quality control check
sum(train.data$race=="black")/nrow(data)
sum(test.data$race=="black")/nrow(test.data)  


# Rough model 1 
summary(lm(wage~edu+exp+city+reg+race+deg+com,data=train.data))

# Rough model 2 
summary(lm(log(wage)~edu+exp+city+reg+race+deg+com,data=train.data))



# EDA (Use smootehrs)

##### com
plot(data$com,log(data$wage))
lines(supsmu(data$com,log(data$wage)),col=2)

##### edu
plot(data$edu,log(data$wage))
lines(supsmu(data$edu,log(data$wage)),col=2)

##### edu
boxplot(log(data$wage)~data$edu)
lines(supsmu(data$edu,log(data$wage)),col=2)


##### exp
plot(data$exp,log(data$wage))
lines(supsmu(data$exp,log(data$wage)),col=2)


##### emp
plot(data$emp,log(data$wage))
lines(supsmu(data$emp,log(data$wage)),col=2)

#### Interaction plots

# City vs. region (yes)
city <- data$city
reg <- data$reg
wage <- data$wage
interaction.plot(city,reg,log(wage))


# race vs. city (maybe not)
race <- data$race
interaction.plot(race,reg,log(wage))


# race vs. city (maybe not)
interaction.plot(race,city,log(wage))



# edu vs.degree (the lines do cross) 
plot(data$edu,log(wage),col=data$deg)
degree <- data$deg=="yes"
abline(lm(log(wage)[degree]~data$edu[degree]),col="red")
abline(lm(log(wage)[-degree]~data$edu[-degree]),col="black")


# exp vs. race (the lines do cross) 
plot(data$exp,log(wage),col=data$race)

plot(data$exp,log(wage))

black <- data$race=="black"
white <- data$race=="white"
other <- data$race=="other"

lines(supsmu(data$exp[black],log(data$wage)[black]),col=2)
lines(supsmu(data$exp[white],log(data$wage)[white]),col=3)
lines(supsmu(data$exp[other],log(data$wage)[other]),col=4)
legend("topright",legend=c("Black","White","Other"),col=c(2,3,4),lty=c(1,1,1))


# Defining indicators (dummy variables)
black <- I(data$race=="black")
white <- I(data$race=="white")
other <- I(data$race=="other")






```


dfram <- data.frame(Wage = d$wage, Edu = d$edu, Exp = d$exp, City = d$city, Region = d$reg, Race = d$race, College = d$deg, Commute = d$com, Employees = d$emp)

head(dfram)

black <- subset(dfram, Race == "black")
white <- subset(dfram, Race == "white")
nonblack <- subset(dfram, Race != "black")

race <- c(rep("black", nrow(black)), rep("white", nrow(white)))
wage <- c(black$Wage, white$Wage)
# remove outliers
boxplot(wage~race, main="boxplot", xlab="Race", ylab="Wage", outline=FALSE)
# log wage
boxplot(log(wage)~race, main="boxplot", xlab="Race", ylab="Wage")


#model.1 <- lm(wage~edu, data=d)
#plot(d$edu, d$wage)
#abline(-32.2755,51.5334)

#summary(model.1)
n <- length(d)
n




### II. Statistical Model

### III. Research Question

### IV. Appendix

#### a. Model Selection

#### b. Diagnostics and Model Validation

#### c. Influential Observations and Collinearity

### d. Others
